<!DOCTYPE html>
<html lang="en">
  <head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2976969447542443"
     crossorigin="anonymous"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2F7W0VSKYS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-2F7W0VSKYS');
    </script>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta charset="UTF-8" content="DQ8cFSEqHz4QBhgwFAIjB29cekImOyUsyd_mQIjKic-ecEPnZq6oyvrt" csrf-param="_csrf_token" method-param="_method" name="csrf-token">
<meta content="rails, auth, token" name="keywords"><meta content="how to handle token auth in rails" name="description">
<title>How to handle token auth in Rails</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;500;600&amp;display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;500;600&amp;display=swap" rel="stylesheet">
    <link phx-track-static rel="stylesheet" href="css/app-02e14b945d8b05cb2897c7e476f6f184%EF%B9%96vsn=d.css"/>
    <script defer phx-track-static type="text/javascript" src="js/app-a031d7efdf9d092a14f7e85a21871ce8%EF%B9%96vsn=d.js"></script>
    <!-- SIDENAV SCRIPT -->
    <script type="text/javascript">
      /* Set the width of the side navigation to 250px */
      function openNav() {
        document.getElementById("mySidenav").style.width = "250px";
        document.getElementById("main").style.marginLeft = "250px";
        document.body.style.backgroundColor = "rgba(0,0,0,0.4)";

        var dropdown = document.getElementsByClassName("dropdown-btn");
        var i;
        for (i = 0; i < dropdown.length; i++) {
          dropdown[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var dropdownContent = this.nextElementSibling;
            if (dropdownContent.style.display === "block") {
              dropdownContent.style.display = "none";
            } else {
              dropdownContent.style.display = "block";
            }
          });
        }
      }

      /* Set the width of the side navigation to 0 */
      function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
        document.getElementById("main").style.marginLeft = "0";
        document.body.style.backgroundColor = "white";
      }
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2976969447542443"
     crossorigin="anonymous"></script>
    <ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-2976969447542443"
     data-ad-slot="2745114693">
    </ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </head>
  <body>

    <div id="mySidenav" class="sidenav">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <!-- FOR WHEN YOU NEED NESTED NAV USE THIS EXAMPLE -->
      <!-- <p class="dropdown-btn">Elixir Phoenix</p>
      <div class="dropdown-container">
        <a href="#">Link 1</a>
        <a href="#">Link 2</a>
      </div> -->
      <a href="page/about.html">About</a>
      <a href="page/attributions.html">Attributions</a>
    </div>

    <nav id="nav">
      <a href="index.html"><img id="logo" class="logo" src="images/logo-7c9e547c805c708decc674b648163720%EF%B9%96vsn=d.svg" alt="DevDecks icon" /></a>
      <a href="studio.html"><img id="settings-icon" class="nav-icon lg" src="images/studio-2-00b6814e1495c4cb9ff6987d9b98753f%EF%B9%96vsn=d.svg" alt="studio icon" /></a>
      <a id="darkmode-toggler"><img id="settings-icon" class="nav-icon" src="images/night-mode-41cf0bc8abaacbbd59e2fdca8ac55a85%EF%B9%96vsn=d.svg" alt="dark mode icon" /></a>
      <img id="settings-icon" onclick="openNav()" class="nav-icon" src="images/more-79c5db1b1206b6b8195fee1ceb385178%EF%B9%96vsn=d.svg" alt="more pages icon" />
    </nav>
    <br />
<main role="main" class="container">
  <p class="alert alert-info" role="alert"></p>
  <p class="alert alert-danger" role="alert"></p>
<div class="page blog-post">
  <div id="2022-how-to-handle-token-auth-in-rails" style="margin-bottom: 3rem;">
<a class="all-posts-link" href="index.html">All posts</a>
    <div class="flex-row-d-column-m">
      <h1 class="link-title">How to handle token auth in Rails</h1>
      <time>2022-01-02</time>
    </div>

    <div class="flex-row-no-space">
      <img class="icon-sm" src="images/tag2-730d3eac769a667d071582853b151791%EF%B9%96vsn=d.svg" />&nbsp<a class="blog-tag" href="tags/rails.html">rails</a><a class="blog-tag" href="tags/auth.html">auth</a><a class="blog-tag" href="tags/token.html">token</a>
    </div>

    <div class="blog-post-body">
<p>
This post is going to demonstrate how to set up a central tokens table for your Rails application, with the goal to better organize access to resources in your application.</p>
<p>
If you did not have a centralized tokens table in your Rails application then each entity that needed different token auth would have to have its own token column on the model and if that entity needed multiple types of tokens, it would have multiple columns on the model. In practice that looks like:</p>
<pre><code>User.last.admin_auth_token
User.last.report_view_token</code></pre>
<pre><code>Report.last.auth_token</code></pre>
<p>
Instead of having these tokens spread across various domains, let‚Äôs create a new tokens database table to house all of these different kinds of tokens and associate them with the application entities they belong to.</p>
<p>
The migration file:</p>
<pre><code>class CreateTokens &lt; ActiveRecord::Migration[5.4]
 def change
   create_table :tokens do |t|
     t.string :kind
     t.datetime :expires_at
     t.string :token
     t.integer :tokenable_id
     t.string :tokenable_type
     t.timestamps null: false
 
     t.index :token
     t.index [:tokenable_id]
   end
 end
end
 
</code></pre>
<p>
The new table columns above briefly defined:</p>
<ul>
  <li>
tokenable_id - id of the user or account that the token is associated with  </li>
  <li>
tokenable_type - was the token created for a user or an account.   </li>
  <li>
token - The actual token string  </li>
  <li>
expires_at - When to revoke the token  </li>
  <li>
kind - Synonym for token type (eg :ADMIN_AUTH_TOKEN)  </li>
</ul>
<p>
Now we need to set up our application to work with this new tokens table. Let‚Äôs first define the Token model. The model does two things: </p>
<ol>
  <li>
Defines two callbacks to set the token and expiry.  </li>
  <li>
Enables the polymorphic relationships using the <code class="inline">tokenable_id</code> and <code class="inline">tokenable_type</code> in the <code class="inline">belongs_to :tokenable</code> method.  </li>
</ol>
<pre><code>class Token &lt; ApplicationRecord
 belongs_to :tokenable, polymorphic: true
 before_create :set_token, :set_expires_in
 
 private
 
 def set_token
   self.token = SecureRandom.urlsafe_base64
 end
 
 def set_expires_in
   expires_in = case kind.to_sym
   when :INVITE_TOKEN then nil
   when :AUTH_TOKEN then 30.days
   when :LOGIN_REDIRECT then 1.day
   else
     raise StandardError
   end
 
   self.expires_at ||= DateTime.now + expires_in
 end
end
</code></pre>
<p>
And for the models that are we are going to be able to create tokens for we will need to define the other side of the relationship. I‚Äôll use Account as an example:</p>
<pre><code>class Account &lt; ApplicationRecord
 has_many :tokens, as: :tokenable, dependent: :destroy
end</code></pre>
<p>
Now that we have both sides of the relationship setup to test, load the Rails console and try it out. Let‚Äôs create a Token for an Account and then try to look it up.</p>
<pre><code>=&gt; Token.create(tokenable_type: Account, tokenable_id: 1, kind: :LOGIN_REDIRECT)
#&lt;Token:0x0018 id: 1 ‚Ä¶.&gt;</code></pre>
<pre><code>=&gt; Account.find(1).tokens.find_by(kind: :LOGIN_REDIRECT)
#&lt;Token:0x0018 id: 1 ‚Ä¶.&gt;</code></pre>
<p>
This is a good example of a refactoring opportunity. If your application has different tokens spread across various domains consider consolidating into a central database table and using the power of Rails polymorphism to make your code cleaner.</p>
<p>
Similar posts:</p>
<ul>
  <li>
<a href="2022-rails-integration-testing-cheatsheet.html" target="_blank">Rails integration testing cheatsheet</a>  </li>
  <li>
<a href="2021-rails-nested-resources-mvc-complete-example.html" target="_blank">Rails nested resources MVC complete example</a>  </li>
</ul>

    </div>
  </div>
</div>

</main>

    <div id="privacy-policy-container">
      <a href="page/privacy.html">Privacy Policy</a>
      <div>Built with üõ†Ô∏è and ‚òï in ‚õ∞Ô∏è</div>
    </div>

  </body>
</html>
